import { Request, Response } from 'express';
import affiliationService from '../services/affiliation.service';
import {
  registrationWindowSchema,
  updateRegistrationWindowSchema,
  stateSecretaryRegistrationSchema,
  districtSecretaryRegistrationSchema,
  clubRegistrationSchema,
  affiliationQuerySchema,
  registrationWindowQuerySchema,
  RegistrationTypeEnum,
} from '../validators/affiliation.validator';
import { successResponse } from '../utils/response.util';
import { asyncHandler } from '../utils/asyncHandler';
import { AppError } from '../utils/errors';
import { AuthRequest } from '../types';

// ==========================================
// REGISTRATION WINDOW CONTROLLERS (ADMIN)
// ==========================================

/**
 * @desc    Create a registration window
 * @route   POST /api/v1/affiliations/windows
 * @access  Private (Global Admin)
 */
export const createRegistrationWindow = asyncHandler(async (req: AuthRequest, res: Response) => {
  const validatedData = registrationWindowSchema.parse(req.body);

  const window = await affiliationService.createRegistrationWindow(
    validatedData,
    String(req.user!.id)
  );

  return successResponse(res, {
    statusCode: 201,
    message: 'Registration window created successfully',
    data: window,
  });
});

/**
 * @desc    Update a registration window
 * @route   PUT /api/v1/affiliations/windows/:id
 * @access  Private (Global Admin)
 */
export const updateRegistrationWindow = asyncHandler(async (req: AuthRequest, res: Response) => {
  const { id } = req.params;
  const validatedData = updateRegistrationWindowSchema.parse(req.body);

  const window = await affiliationService.updateRegistrationWindow(
    id,
    validatedData,
    String(req.user!.id)
  );

  return successResponse(res, {
    message: 'Registration window updated successfully',
    data: window,
  });
});

/**
 * @desc    Get all registration windows
 * @route   GET /api/v1/affiliations/windows
 * @access  Private (Global Admin)
 */
export const getRegistrationWindows = asyncHandler(async (req: AuthRequest, res: Response) => {
  const query = registrationWindowQuerySchema.parse(req.query);

  const windows = await affiliationService.getRegistrationWindows(query);

  return successResponse(res, {
    message: 'Registration windows retrieved successfully',
    data: windows,
  });
});

/**
 * @desc    Delete/deactivate a registration window
 * @route   DELETE /api/v1/affiliations/windows/:id
 * @access  Private (Global Admin)
 */
export const deleteRegistrationWindow = asyncHandler(async (req: AuthRequest, res: Response) => {
  const { id } = req.params;

  await affiliationService.deleteRegistrationWindow(id, String(req.user!.id));

  return successResponse(res, {
    message: 'Registration window deactivated successfully',
  });
});

// ==========================================
// PUBLIC REGISTRATION STATUS CHECK
// ==========================================

/**
 * @desc    Check registration status for a type
 * @route   GET /api/v1/affiliations/status/:type
 * @access  Public
 */
export const checkRegistrationStatus = asyncHandler(async (req: Request, res: Response) => {
  const { type } = req.params;

  const validType = RegistrationTypeEnum.safeParse(type);
  if (!validType.success) {
    throw new AppError('Invalid registration type', 400);
  }

  const status = await affiliationService.isRegistrationOpen(validType.data);

  return successResponse(res, {
    message: 'Registration status retrieved',
    data: status,
  });
});

/**
 * @desc    Get all registration statuses
 * @route   GET /api/v1/affiliations/status
 * @access  Public
 */
export const getAllRegistrationStatuses = asyncHandler(async (req: Request, res: Response) => {
  const [stateSecretary, districtSecretary, club] = await Promise.all([
    affiliationService.isRegistrationOpen('STATE_SECRETARY'),
    affiliationService.isRegistrationOpen('DISTRICT_SECRETARY'),
    affiliationService.isRegistrationOpen('CLUB'),
  ]);

  return successResponse(res, {
    message: 'Registration statuses retrieved',
    data: {
      STATE_SECRETARY: stateSecretary,
      DISTRICT_SECRETARY: districtSecretary,
      CLUB: club,
    },
  });
});

// ==========================================
// STATE SECRETARY CONTROLLERS
// ==========================================

/**
 * @desc    Register as State Secretary
 * @route   POST /api/v1/affiliations/state-secretary
 * @access  Public (when registration is open)
 */
export const registerStateSecretary = asyncHandler(async (req: Request, res: Response) => {
  const validatedData = stateSecretaryRegistrationSchema.parse(req.body);

  // Get active window
  const { isOpen, window, message } = await affiliationService.isRegistrationOpen('STATE_SECRETARY');

  if (!isOpen || !window) {
    throw new AppError(message, 400);
  }

  const secretary = await affiliationService.registerStateSecretary(
    validatedData,
    window.id
  );

  return successResponse(res, {
    statusCode: 201,
    message: 'State Secretary registration submitted successfully. Pending approval.',
    data: {
      uid: secretary.uid,
      name: secretary.name,
      state: secretary.state,
    },
  });
});

/**
 * @desc    Get all state secretaries
 * @route   GET /api/v1/affiliations/state-secretary
 * @access  Private (Global Admin)
 */
export const listStateSecretaries = asyncHandler(async (req: AuthRequest, res: Response) => {
  const query = affiliationQuerySchema.parse(req.query);

  const result = await affiliationService.listStateSecretaries(query);

  return successResponse(res, {
    message: 'State secretaries retrieved successfully',
    data: result,
  });
});

/**
 * @desc    Approve/Reject state secretary
 * @route   PUT /api/v1/affiliations/state-secretary/:id/status
 * @access  Private (Global Admin)
 */
export const updateStateSecretaryStatus = asyncHandler(async (req: AuthRequest, res: Response) => {
  const { id } = req.params;
  const { status, remarks } = req.body;

  if (!['APPROVED', 'REJECTED'].includes(status)) {
    throw new AppError('Invalid status. Must be APPROVED or REJECTED', 400);
  }

  if (status === 'REJECTED' && !remarks) {
    throw new AppError('Remarks are required when rejecting', 400);
  }

  const secretary = await affiliationService.updateStateSecretaryStatus(
    id,
    status,
    String(req.user!.id),
    remarks
  );

  return successResponse(res, {
    message: `State Secretary ${status.toLowerCase()} successfully`,
    data: secretary,
  });
});

// ==========================================
// DISTRICT SECRETARY CONTROLLERS
// ==========================================

/**
 * @desc    Register as District Secretary
 * @route   POST /api/v1/affiliations/district-secretary
 * @access  Public (when registration is open)
 */
export const registerDistrictSecretary = asyncHandler(async (req: Request, res: Response) => {
  const validatedData = districtSecretaryRegistrationSchema.parse(req.body);

  // Get active window
  const { isOpen, window, message } = await affiliationService.isRegistrationOpen('DISTRICT_SECRETARY');

  if (!isOpen || !window) {
    throw new AppError(message, 400);
  }

  const secretary = await affiliationService.registerDistrictSecretary(
    validatedData,
    window.id
  );

  return successResponse(res, {
    statusCode: 201,
    message: 'District Secretary registration submitted successfully. Pending approval.',
    data: {
      uid: secretary.uid,
      name: secretary.name,
      state: secretary.state,
      district: secretary.district,
    },
  });
});

/**
 * @desc    Get all district secretaries
 * @route   GET /api/v1/affiliations/district-secretary
 * @access  Private (Global Admin, State Secretary)
 */
export const listDistrictSecretaries = asyncHandler(async (req: AuthRequest, res: Response) => {
  const query = affiliationQuerySchema.parse(req.query);

  // State secretary can only see their state
  if (req.user!.role === 'STATE_SECRETARY') {
    query.stateId = req.user!.stateId;
  }

  const result = await affiliationService.listDistrictSecretaries(query);

  return successResponse(res, {
    message: 'District secretaries retrieved successfully',
    data: result,
  });
});

/**
 * @desc    Approve/Reject district secretary
 * @route   PUT /api/v1/affiliations/district-secretary/:id/status
 * @access  Private (Global Admin, State Secretary)
 */
export const updateDistrictSecretaryStatus = asyncHandler(async (req: AuthRequest, res: Response) => {
  const { id } = req.params;
  const { status, remarks } = req.body;

  if (!['APPROVED', 'REJECTED'].includes(status)) {
    throw new AppError('Invalid status. Must be APPROVED or REJECTED', 400);
  }

  if (status === 'REJECTED' && !remarks) {
    throw new AppError('Remarks are required when rejecting', 400);
  }

  const secretary = await affiliationService.updateDistrictSecretaryStatus(
    id,
    status,
    String(req.user!.id),
    remarks
  );

  return successResponse(res, {
    message: `District Secretary ${status.toLowerCase()} successfully`,
    data: secretary,
  });
});

// ==========================================
// CLUB CONTROLLERS
// ==========================================

/**
 * @desc    Register a Club
 * @route   POST /api/v1/affiliations/club
 * @access  Public (when registration is open)
 */
export const registerClub = asyncHandler(async (req: Request, res: Response) => {
  const validatedData = clubRegistrationSchema.parse(req.body);

  // Get active window
  const { isOpen, window, message } = await affiliationService.isRegistrationOpen('CLUB');

  if (!isOpen || !window) {
    throw new AppError(message, 400);
  }

  const club = await affiliationService.registerClub(
    validatedData,
    window.id
  );

  return successResponse(res, {
    statusCode: 201,
    message: 'Club registration submitted successfully. Pending approval.',
    data: {
      uid: club.uid,
      name: club.name,
      code: club.code,
      state: club.state,
      district: club.district,
    },
  });
});

/**
 * @desc    Get all clubs
 * @route   GET /api/v1/affiliations/club
 * @access  Private (Global Admin, State Secretary, District Secretary)
 */
export const listClubs = asyncHandler(async (req: AuthRequest, res: Response) => {
  const query = affiliationQuerySchema.parse(req.query);

  // Apply hierarchy filter
  if (req.user!.role === 'STATE_SECRETARY') {
    query.stateId = req.user!.stateId;
  } else if (req.user!.role === 'DISTRICT_SECRETARY') {
    query.districtId = req.user!.districtId;
  }

  const result = await affiliationService.listClubs(query);

  return successResponse(res, {
    message: 'Clubs retrieved successfully',
    data: result,
  });
});

/**
 * @desc    Approve/Reject club
 * @route   PUT /api/v1/affiliations/club/:id/status
 * @access  Private (Global Admin, State Secretary, District Secretary)
 */
export const updateClubStatus = asyncHandler(async (req: AuthRequest, res: Response) => {
  const { id } = req.params;
  const { status, remarks } = req.body;

  if (!['APPROVED', 'REJECTED'].includes(status)) {
    throw new AppError('Invalid status. Must be APPROVED or REJECTED', 400);
  }

  if (status === 'REJECTED' && !remarks) {
    throw new AppError('Remarks are required when rejecting', 400);
  }

  const club = await affiliationService.updateClubStatus(
    id,
    status,
    String(req.user!.id),
    remarks
  );

  return successResponse(res, {
    message: `Club ${status.toLowerCase()} successfully`,
    data: club,
  });
});

export default {
  // Registration Windows
  createRegistrationWindow,
  updateRegistrationWindow,
  getRegistrationWindows,
  deleteRegistrationWindow,

  // Status Check
  checkRegistrationStatus,
  getAllRegistrationStatuses,

  // State Secretary
  registerStateSecretary,
  listStateSecretaries,
  updateStateSecretaryStatus,

  // District Secretary
  registerDistrictSecretary,
  listDistrictSecretaries,
  updateDistrictSecretaryStatus,

  // Club
  registerClub,
  listClubs,
  updateClubStatus,
};
